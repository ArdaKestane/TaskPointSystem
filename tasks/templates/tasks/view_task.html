{% extends "tasks/base.html" %}
{% load static %}

{% block content %}
    <div class="row">
        <div class="col-sm-2"></div>
        <div class="col-sm-8" style="padding: 30px 20px 0 30px">

            <div class="row task-status-bar mg-b-10">
                {% with 'tasks/task_status_pngs/'|add:task.get_status_display|add:'.png' as image_static %}
                    <img src="{% static image_static %}" alt="Review status" id="task-status">
                {% endwith %}
            </div>

            <div class="row task-and-team-name mg-b-10">
                <div class="col-sm-6">
                    <h3>{{ task.title }}</h3>
                </div>
                <div class="col-sm-6">
                    <div class="team-name float-right">
                        <h3>{{ task.team }}</h3>
                    </div>
                </div>
            </div>

            <div class="row task-details-card mg-b-10 mg-t-10">
                <div class="col-sm-6">
                    <table class="task-info-table">
    {#                    <tr><td>Milestone</td><td>:</td><td>{{ task.milestone }}</td></tr>#}
                        <tr><td>Assigned to</td><td>:</td><td>{{ task.assignee }}</td></tr>
                        <tr><td>Priority</td><td>:</td><td bgcolor={{ priority_color }}>{{ task.get_priority_display }}</td></tr>
                        <tr><td>Difficulty</td><td>:</td><td bgcolor={{ difficulty_color }}>{{ task.get_difficulty_display }}</td></tr>
                        <tr><td>Created on</td><td>:</td><td>{{ task.date }}</td></tr>
                        <tr><td>Due Date</td><td>:</td><td>{{ task.due }}</td></tr>
                        <tr><td>Last Modified by</td><td>:</td><td>{{ task.creator }}</td></tr>
                        <tr><td>Last Modified</td><td>:</td><td>{{ task.completed }}</td></tr>
                        <tr><td><button type="button" class="btn btn-info" id="task-more-details"><i>More details</i></button></td></tr>
                    </table>
                </div>
                <div class="col-sm-6">
                    <table class="task-info-table">
                        <tr><td>Description</td><td>:</td><td>{{ task.description|linebreaksbr }}</td></tr>
    {#                    <tr><td>Modifier</td><td>:</td><td>{{ task.modifier }}</td></tr>#}
    {#                    <tr><td>Task Point ( (p*d) + m)</td><td>:</td><td>{{ task.get_points }}</td></tr>#}
    {#                    <tr><td>Status</td><td>:</td><td>{{ task.get_status_display }}</td></tr>#}
                        {% if task.status == 1 or task.status == 2 %}
                            <tr><td>Creation Accept Votes</td><td>:</td><td>{{ task.get_creation_accept_votes.count }}</td></tr>
                            <tr><td>Creation Change Votes</td><td>:</td><td>{{ task.get_creation_change_votes.count }}</td></tr>
                        {% else %}
                            <tr><td>Submission Accept Votes</td><td>:</td><td>{{ task.get_submission_accept_votes.count }}</td></tr>
                            <tr><td>Submission Change Votes</td><td>:</td><td>{{ task.get_submission_change_votes.count }}</td></tr>
                        {% endif %}
                    </table>
                </div>
            </div>

            <div class="row task-additional-details">
                <h4>Additional Details</h4>
                <table class="task-info-table">
                    <tr><td>Milestone</td><td>:</td><td>{{ task.milestone }}</td></tr>
                    <tr><td>Modifier</td><td>:</td><td>{{ task.modifier }}</td></tr>
                    <tr><td>Task Point ((p*d) + m)</td><td>:</td><td>{{ task.get_points }}</td></tr>
                    <tr><td>Status</td><td>:</td><td>{{ task.get_status_display }}</td></tr>
                </table>
            </div>

            <div class="row task-buttons mg-b-10 mg-t-10">
                {# SUPERVISOR #}
                {% if user_s and task.status == 1 or user_s and task.status == 3 or user_s and task.status == 4 %}
                    {% if user_s and task.status == 3 or user_s and task.status == 4 %}
                        Set Modifier to:
                        <a href="{% url 'tasks:update-task-mod' task.id 1 %}" class="btn btn-default" role="button">1</a>
                        <a href="{% url 'tasks:update-task-mod' task.id 2 %}" class="btn btn-default" role="button">2</a>
                        <a href="{% url 'tasks:update-task-mod' task.id 3 %}" class="btn btn-default" role="button">3</a>
                        <a href="{% url 'tasks:update-task-mod' task.id 4 %}" class="btn btn-default" role="button">4</a>
                        <a href="{% url 'tasks:update-task-mod' task.id 5 %}" class="btn btn-default" role="button">5</a>
                        <hr />
                    {% endif %}
                    {% if task.status == 3 or task.status == 4 %}
                        <a href="{% url 'tasks:update' task.id 6 %}" class="btn btn-default btn-success" role="button" onclick="return ensure('accept')">Accept</a>
                    {% else %}
                        <a href="{% url 'tasks:update' task.id 2 %}" class="btn btn-default btn-success" role="button" onclick="return ensure('accept')">Accept</a>
                    {% endif %}

                    <a href="{% url 'tasks:update' task.id 5 %}" class="btn btn-default btn-danger" role="button" onclick="return ensure('reject')">Reject</a>
                {% endif %}

                {# DEVELOPER #}
                {% if user_d and task.status == 1 and can_edit == None and can_vote %}
                    <a href="{% url 'tasks:send-vote' task_id=task.id status_id=1 button_id=1 %}" class="btn btn-default btn-success" role="button">Accept</a>
                    <a href="{% url 'tasks:send-vote' task_id=task.id status_id=1 button_id=2 %}" class="btn btn-default btn-danger" role="button">Request Change</a>
                {% elif user_d and task.status == 2 and can_edit != None and can_change_status %}
                    <a href="{% url 'tasks:update' task.id 3 %}" class="btn btn-default btn-warning" role="button">Submit for Review</a>
                {% elif user_d and task.status == 3 and can_edit == None and can_vote %}
                    <a href="{% url 'tasks:send-vote' task_id=task.id status_id=3 button_id=3 %}" class="btn btn-default btn-success" role="button">Accept</a>
                    <a href="{% url 'tasks:send-vote' task_id=task.id status_id=3 button_id=4 %}" class="btn btn-default btn-danger" role="button">Request Change</a>
                {% elif user_d and task.status == 3 and can_edit == 'developer' %}
                    {% if half_the_team_accepted %}
                        <a
                            href="{% url 'tasks:update' task.id 4 %}"
                            class="btn btn-default btn-success"
                            role="button"
                            title="Change status to 'Waiting for supervisor grade' without waiting for all your team members"
                            onclick="return ensure('change the status to \'Waiting for supervisor grade\'')"
                        >Proceed</a>
                    {% endif %}
                    {% if submission_needs_change %}
                        <a
                            href="{% url 'tasks:update' task.id 2 %}"
                            class="btn btn-default btn-info"
                            role="button"
                            title="Change status back to 'Working on it'"
                            onclick="return ensure('change the status to \'Working on it\'')"
                        >Recede</a>
                    {% endif %}
                {% elif user_d and can_edit == 'developer' and task.status == 1 %}
                    {% if can_vote and task.creator != user_d.user%}
                        <a href="{% url 'tasks:send-vote' task_id=task.id status_id=1 button_id=1 %}" class="btn btn-default btn-success" role="button">Accept</a>
                        <a href="{% url 'tasks:send-vote' task_id=task.id status_id=1 button_id=2 %}" class="btn btn-default btn-danger" role="button">Request Change</a>
                    {% endif %}
                    {% if half_the_team_accepted %}
                        <a
                            href="{% url 'tasks:update' task.id 2 %}"
                            class="btn btn-default btn-success"
                            role="button"
                            title="Change status to 'Working on it' without waiting for all your team members"
                            onclick="return ensure('change the status to \'Working on it\'')"
                        >Proceed</a>
                    {% endif %}
                    {% if creation_needs_change %}
                        <a href="{% url 'tasks:task-edit-developer' task_id=task.id %}" class="btn btn-default btn-primary" role="button" title="Edit your task details">Edit</a>
                    {% endif %}
                {% elif user_d %}
                    <p>You can not vote anymore</p>
                {% endif %}

                {# SUPERVISOR #}
                {% if can_edit == "supervisor" and task.status != 2 and task.status != 5 and task.status != 6 %}
                    <a href="{% url 'tasks:task-edit-supervisor' task_id=task.id %}" class="btn btn-default btn-primary" role="button">Edit</a>
                {% endif %}
            </div>

            <div class="row task-comment-form">
                <h3>Comments</h3>
                <form action="{% url 'tasks:send-comment' tid %}" method="post">
                    {% csrf_token %}
                    {% for field in form %}
                        {% if final_comment|length < 1 and field.name == "is_final" and user_d == task.assignee and task.status == 2 %}
                            {{ field.label_tag }}{{ field }}
                        {% elif field.name != "is_final" %}
                            {{ field.label_tag }}{{ field }}
                        {% endif %}
                    {% endfor %}
                    <div style="text-align: right; padding: 4px;"><input type="submit" value="Submit" class="btn btn-success" id="send" /></div>
                </form>
            </div>

            <div class="row task-comments mg-t-10">
                {% if final_comment %}
                    <i class="fa fa-check fa-2x" aria-hidden="true"></i>
                    <ul class="list-group">
                        {% for f_comment in final_comment %}
                            <li class="list-group-item">
                              <div class="row">
                                  <div class="col-sm-6">
                                     <p style="font-size: 1.3rem"><b>{{f_comment.owner}}</b></p>
                                  </div>
                                  <div class="col-sm-6">
                                    <p style="text-align: right">{{f_comment.date}}</p>
                                  </div>
                              </div>
                              <hr class="content-separator" style="margin: -12px 0 10px 0">
                              <p>{{f_comment.body|linebreaksbr}}</p>
                              {% if f_comment.file_url %}
                              <p>File URL: <a href="{{f_comment.file_url }}">{{f_comment.file_url }}</a></p>
                              {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if all_comments_but_final %}
                    <ul class="list-group">
                        {% for comment in all_comments_but_final %}
                            <li class="list-group-item" style="border: 1px solid rgba(206, 212, 218, 0.9)">
                                <div class="row">
                                    <div class="col-sm-6">
                                     <p style="font-size: 1.3rem"><b>{{comment.owner}}</b></p>
                                    </div>
                                    <div class="col-sm-6">
                                    <p style="text-align: right">{{comment.date}}</p>
                                    </div>
                                </div>
                                <hr class="content-separator" style="margin: -12px 0 10px 0">
                                <p>{{comment.body|linebreaksbr}}</p>
                                {% if comment.file_url %}
                                <p>File URL: <a href="{{comment.file_url }}">{{comment.file_url }}</a></p>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            </div>
        <div class="col-sm-2"></div>
    </div>

    <div style="margin-top: 20px">
        {% for message in messages %}
            <div class="alert alert-danger">
                <a class="close" href="#" data-dismiss="alert">×</a>
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endblock %}
{% block scriptcontent %}
    <script>
      $("input, select, textarea").addClass("form-control");
      $("#send").removeClass("form-control");
      $("td").css("padding", "4px");
    </script>
{% endblock %}
